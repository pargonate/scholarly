---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Course Composer" description="Add & Edit courses with an form">
	<form>
		<div id="ID-area" hidden>
			<label for="courseID">ID:</label>
			<input type="text" id="courseID" name="courseID" disabled />
		</div>
		<div>
			<label for="courseName">Name:</label>
			<input type="text" id="courseName" name="courseName" required />
		</div>
		<div>
			<label for="courseSubject">Subject Area:</label>
			<input type="text" id="courseSubject" name="courseSubject" required />
		</div>
		<div>
			<label for="courseDescription">Description:</label>
			<textarea id="courseDescription" name="courseDescription" required></textarea>
		</div>
		<div>
			<label for="courseCredits">Credit(s):</label>
			<input type="number" id="courseCredits" name="courseCredits" required />
		</div>
		<button type="submit" id="courseSubmit">Create Course</button>
	</form>
	<script defer>
		var mode = "";
		var xataID = "";

		async function compose(mode, courseName, courseSubject, courseDescription, courseCredits) {
			if (mode == "") {
				try {
					await fetch("api/course", {
						method: "POST",
						body: JSON.stringify ({
							name: courseName,
							subject: courseSubject,
							description: courseDescription,
							credits: courseCredits
						}),
					});
				} catch (error) {
					alert("An error occurred. Please try again later, or check the console (CTRL + SHIFT + I) for more information.");
					console.log(`ðŸ›‘ Course ${courseName} failed to POST: ${error}`);
				}

				console.log(`âœ… Course ${courseName} created!`);
				alert(`Course ${courseName} created!`);
				window.location.href = "/";
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			const url = new URL(window.location.href);
			const params = url.searchParams;

			if (params.get("mode") === "modify") {
				mode = "modify";
				xataID = params.get("id") || "0";
				document.getElementById("ID-area").hidden = false;
				document.getElementById("courseID").textContent = xataID
			}
		});

		document.getElementById("courseSubmit").addEventListener("click", (e) => {
			e.preventDefault();

			const courseName = document.getElementById("courseName").value;
			const courseSubject = document.getElementById("courseSubject").value;
			const courseDescription = document.getElementById("courseDescription").value;
			const courseCredits = document.getElementById("courseCredits").value;

			if (!courseName || !courseSubject || !courseDescription || !courseCredits) {
				console.log("Fields Missing!")
				alert("Fields Missing!")
			} else {
				compose(mode, courseName, courseSubject, courseDescription, parseInt(courseCredits))
			}
		})
	</script>
</Layout>