---
// Route Protection (Server)
import { protectRoute } from "../lib/auth.ts";
const result = await protectRoute(Astro);

if (result.redirect) {
	return Astro.redirect(result.redirect);
}

// Server-Client 
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";

let courses = []

try {
	const response = await fetch(`${import.meta.env.SERVER_URL}/api/courses`);
	courses = await response.json();
} catch (error) {
	console.log(`ðŸ›‘ Supabase failed to GET: ${error}`);
}
---

<Layout title="Courses" description="See all courses">
	<table>
		<thead>
			<tr>
				<th>Name</th>
				<th>Teacher</th>
				<th>Subject</th>
				<th>Description</th>
				<th>Credits</th>
			</tr>
		</thead>
		<tbody>
			{courses.map((course) => (
				<tr>
					<td>
						<div id="courseName-wrapper">
							{course.name} ({course.course_id})
							<div id="courseControls">
								{/* 
									Since editing isn't an immediate action (unlike delete),
									we send the user to the backend-enabled form /composer.
								*/}
								<a href={`/composer?mode=modify&id=${course.course_id}`} class="courseControl">
									<Icon name="ri:pencil-fill" />
								</a>
								<button class="courseDelete courseControl" data-courseID={course.course_id} data-courseName={course.name}>
									<Icon name="ri:delete-bin-5-line" />
								</button>
							</div>
						</div>
					</td>
					<td>{course.creator_name}</td>
					<td>{course.subject}</td>
					<td>{course.description}</td>
					<td>{course.credits}</td>
				</tr>
			))}
		</tbody>
	</table>	
	<a href="/composer"><button>Create a Course (TEACHERS ONLY!)</button></a>
</Layout>
<style>
	table {
		border-collapse: collapse;
		width: 100%;
		color: #FFF;
	}

	th,
	td {
		border: 1px solid #000;
		padding: 8px;
		/* width: fit-content; */
	}

	#courseName-wrapper {
		display: flex;
		gap: 15px;
	}

		#courseControls {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 5px;
		}

	.courseControl {
		all: unset;
		line-height: 0px;
		cursor: pointer;
	}

	th {
		background-color: #0a0a0a;
		text-align: left;
	}
</style>
<script defer>
	//
	// Deleting a Course
	//	Since deletion is an action, that doesn't need to edit any values,
	//	we must assign a event listener to a button to execute a DELETE
	//	request.
	//

	const courseDelete = document.querySelectorAll(".courseDelete");

	// Assign the delete operation to all buttons (since there will be many courses)
	courseDelete.forEach(control => {
		control.addEventListener("click", async (e) => {
			e.preventDefault();
			// Course Properties stored in attributes for efficient retrieval 
			let courseID = control.getAttribute("data-courseID");
			let courseName = control.getAttribute("data-courseName")

			// Confirmation just to be safe
			if (confirm(`Are you sure you want to the ${courseName} course?`)) {
				try {
					await fetch(`api/course/${courseID}`, {
						method: "DELETE"
					});
				} catch (error) {
					alert("An error occurred. Please try again later, or check the console (CTRL + SHIFT + I) for more information.");
					console.log(`ðŸ›‘ Course ${courseID} failed to DELETE: ${error}`);
				}

				alert(`Course ${courseName} deleted!`);
				console.log(`âœ… Course ${courseName} deleted!`);
				// Auto reload (because I care about my user's time)
				window.location.reload();
			}
		});
	});
</script>