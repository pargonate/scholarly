---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
	return Astro.redirect("/signin");
}

let session;
try {
	session = await supabase.auth.setSession({
		refresh_token: refreshToken.value,
		access_token: accessToken.value,
	});

	if (session.error) {
		Astro.cookies.delete("sb-access-token", {
			path: "/",
		});

		Astro.cookies.delete("sb-refresh-token", {
			path: "/",
		});

		return redirect("/signin");
	}
} catch (error) {
	Astro.cookies.delete("sb-access-token", {
		path: "/",
	});

	Astro.cookies.delete("sb-refresh-token", {
		path: "/",
	});

	return Astro.redirect("/signin");
}

const user = session.data.user;
const metadata = session.data.user?.user_metadata;
const name = `${metadata.first_name} ${metadata.last_name}`;
const role = metadata.role;
---

<Layout title="Courses" description="See all courses">
	<h2>Welcome [{role}] {name}</h2>
	<form action="/api/auth/signout">
		<button type="submit">Sign out</button>
	</form>
</Layout>